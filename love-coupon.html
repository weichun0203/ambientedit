<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸¸æº«å…Œæ›åˆ¸è¨­è¨ˆå·¥å» ï½œAmbient Voucher Studio</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="å¸¸æº«ç·¨é›†æ‰€æä¾›çš„å®¢è£½åŒ–å…Œæ›åˆ¸ç”¢ç”Ÿå™¨ï¼Œç‚ºç”Ÿæ´»å¢æ·»ä¸€é»å„€å¼æ„Ÿã€‚">
    <meta name="author" content="å¸¸æº«ç·¨é›†æ‰€ Ambient Edit Studio">
    
    <!-- JSON-LD for Brand -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "å¸¸æº«å…Œæ›åˆ¸è¨­è¨ˆå·¥å» ",
      "alternateName": "Ambient Voucher Studio",
      "url": "https://weichun0203.github.io/ambientedit/",
      "author": {
        "@type": "Organization",
        "name": "å¸¸æº«ç·¨é›†æ‰€ Ambient Edit Studio"
      }
    }
    </script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2F079YMSFW"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-2F079YMSFW');
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Noto+Serif+TC:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            paper: '#fdfbf7',
                            ink: '#4a4a4a',
                            sage: '#8da399',
                            clay: '#d4a59a',
                            sand: '#e6e2dd',
                        }
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fdfbf7;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
            color: #4a4a4a;
        }

        .font-serif { font-family: 'Noto Serif TC', serif; }

        /* Modal Animation */
        .modal-enter { opacity: 0; transform: scale(0.9); }
        .modal-active { opacity: 1; transform: scale(1); transition: opacity 0.3s, transform 0.3s; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e6e2dd; border-radius: 10px; }

        /* Capture container to avoid scaling issues on mobile */
        #capture-container {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 600px;
        }
        
        /* Fix for FontAwesome vertical alignment in html2canvas */
        .fa-icon-fix {
            display: inline-block;
            line-height: 1 !important;
            vertical-align: middle;
            text-align: center;
        }
        
        /* Loading Overlay */
        #loading-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(253, 251, 247, 0.8);
            backdrop-blur: 5px;
            z-index: 100;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col py-8 px-4 sm:px-12">

    <div id="loading-overlay">
        <div class="w-8 h-8 border-4 border-brand-sage border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-xs font-bold tracking-widest text-brand-sage uppercase">æ­£åœ¨ç”Ÿæˆç¥¨åˆ¸...</p>
    </div>

    <!-- Header Section -->
    <header class="w-full max-w-6xl mx-auto mb-12 border-b border-brand-sand pb-8">
        <div class="flex flex-col md:flex-row justify-between items-end gap-6">
            <div class="flex flex-col flex-1">
                <span class="text-brand-sage font-bold tracking-[0.3em] text-xs mb-2 uppercase">å¸¸æº«ç·¨é›†æ‰€ Ambient Edit Studio</span>
                <h1 class="text-3xl md:text-5xl font-serif text-brand-ink tracking-tight flex items-center">
                    å…Œæ›åˆ¸è¨­è¨ˆå·¥å» 
                </h1>
                <p class="mt-4 text-brand-sage/80 text-sm max-w-md font-medium">
                    å°‡ç”Ÿæ´»ä¸­çš„æº«æ½¤æ‰¿è«¾ï¼Œè½‰åŒ–ç‚ºä¸€ä»½å¯ä»¥æ¡åœ¨æ‰‹ä¸­çš„æº«æš–ã€‚è£½ä½œå°ˆå±¬çš„ç¥¨åˆ¸ï¼Œå‚³éæœ€ç´°è†©çš„å¿ƒæ„ã€‚
                </p>
            </div>
            
            <div class="flex-shrink-0">
                <a href="https://weichun0203.github.io/ambientedit/" 
                   class="group inline-flex items-center px-6 py-2.5 rounded-full border border-brand-sand hover:border-brand-sage hover:bg-white transition-all duration-300 shadow-sm hover:shadow-soft bg-white/50 backdrop-blur-sm"
                   aria-label="è¿”å›å¸¸æº«é¦–é "
                   style="text-decoration: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-brand-sage group-hover:text-brand-ink transition-colors duration-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                    <span class="ml-2 text-xs font-bold tracking-widest text-brand-sage group-hover:text-brand-ink transition-colors duration-300">
                        å¸¸æº«é¦–é 
                    </span>
                </a>
            </div>
        </div>
    </header>

    <main class="w-full max-w-6xl mx-auto flex flex-col lg:flex-row gap-12 items-start flex-grow">
        
        <!-- Controls Section -->
        <section class="w-full lg:w-1/3 bg-white/80 backdrop-blur-md p-6 rounded-2xl shadow-soft border border-brand-sand">
            <h2 class="text-sm font-bold mb-6 text-brand-sage flex items-center tracking-widest uppercase">
                <i class="fa-solid fa-sliders mr-2"></i> è¨­å®šç¥¨åˆ¸ç´°ç¯€
            </h2>

            <!-- Quick Templates Grid -->
            <div class="mb-8">
                <label class="block text-[10px] font-bold text-brand-sage/60 mb-3 uppercase tracking-widest">å¿«é€Ÿéˆæ„Ÿæ¨¡æ¿</label>
                <div class="grid grid-cols-2 gap-2 max-h-72 overflow-y-auto pr-1 custom-scrollbar">
                    <button onclick="applyTemplate('bf')" class="text-[11px] bg-brand-sand/30 hover:bg-brand-clay/10 text-brand-ink p-2 rounded-lg transition-all border border-transparent hover:border-brand-clay/20 flex items-center gap-2">
                        <i class="fa-solid fa-heart text-brand-clay"></i> è¶…ç´šç”·å‹åˆ¸
                    </button>
                    <button onclick="applyTemplate('massage')" class="text-[11px] bg-brand-sand/30 hover:bg-brand-sage/10 text-brand-ink p-2 rounded-lg transition-all border border-transparent hover:border-brand-sage/20 flex items-center gap-2">
                        <i class="fa-solid fa-hand-holding-heart text-brand-sage"></i> å°ˆå±¬æŒ‰æ‘©åˆ¸
                    </button>
                    <button onclick="applyTemplate('food')" class="text-[11px] bg-brand-sand/30 hover:bg-amber-100/50 text-brand-ink p-2 rounded-lg transition-all border border-transparent hover:border-amber-200 flex items-center gap-2">
                        <i class="fa-solid fa-utensils text-amber-600"></i> å¤§é¤è«‹å®¢åˆ¸
                    </button>
                    <button onclick="applyTemplate('chores')" class="text-[11px] bg-brand-sand/30 hover:bg-gray-100 text-brand-ink p-2 rounded-lg transition-all border border-transparent hover:border-gray-200 flex items-center gap-2">
                        <i class="fa-solid fa-broom text-gray-500"></i> å…åšå®¶äº‹åˆ¸
                    </button>
                    <button onclick="applyTemplate('trip')" class="text-[11px] bg-brand-sand/30 hover:bg-purple-100/50 text-brand-ink p-2 rounded-lg transition-all border border-transparent hover:border-purple-200 flex items-center gap-2">
                        <i class="fa-solid fa-plane text-purple-600"></i> èªªèµ°å°±èµ°åˆ¸
                    </button>
                    <button onclick="applyTemplate('breakup')" class="text-[11px] bg-brand-clay/20 hover:bg-brand-clay/30 text-brand-ink p-2 rounded-lg transition-all border border-transparent hover:border-brand-clay flex items-center gap-2">
                        <i class="fa-solid fa-wind text-brand-clay"></i> åˆ†æ‰‹å®‰æ…°åˆ¸
                    </button>
                    <button onclick="applyTemplate('drink')" class="text-[11px] bg-brand-sand/30 hover:bg-brand-sand/60 text-brand-ink p-2 rounded-lg transition-all border border-transparent hover:border-brand-sage flex items-center gap-2">
                        <i class="fa-solid fa-wine-glass text-brand-ink"></i> é…’ç²¾æ¶ˆæ„åˆ¸
                    </button>
                    <button onclick="applyTemplate('restart')" class="text-[11px] bg-brand-sage/20 hover:bg-brand-sage/30 text-brand-ink p-2 rounded-lg transition-all border border-transparent hover:border-brand-sage flex items-center gap-2">
                        <i class="fa-solid fa-seedling text-brand-sage"></i> é‡æ–°é–‹å§‹åˆ¸
                    </button>
                    <button onclick="applyTemplate('cry')" class="text-[11px] bg-blue-100/30 hover:bg-blue-100/60 text-brand-ink p-2 rounded-lg transition-all border border-transparent hover:border-blue-300 flex items-center gap-2">
                        <i class="fa-solid fa-droplet text-blue-500"></i> ç„¡ä¸Šé™é™ªå“­åˆ¸
                    </button>
                    <button onclick="applyTemplate('forgive')" class="text-[11px] bg-brand-sand/30 hover:bg-blue-100/50 text-brand-ink p-2 rounded-lg transition-all border border-transparent hover:border-blue-200 flex items-center gap-2">
                        <i class="fa-solid fa-flag text-blue-600"></i> ç„¡æ¢ä»¶åŸè«’
                    </button>
                </div>
            </div>
            
            <div class="space-y-6">
                <!-- Color -->
                <div>
                    <label class="block text-[10px] font-bold text-brand-sage/60 mb-3 uppercase tracking-widest">é¸æ“‡æ°›åœè‰²ç³»</label>
                    <div class="flex gap-3 flex-wrap" id="color-picker">
                        <button class="w-6 h-6 rounded-full bg-[#fce7f3] border border-pink-200" onclick="updateColor('bg-[#fce7f3]', 'text-pink-800')"></button>
                        <button class="w-6 h-6 rounded-full bg-[#e0f2fe] border border-blue-200" onclick="updateColor('bg-[#e0f2fe]', 'text-blue-800')"></button>
                        <button class="w-6 h-6 rounded-full bg-[#fef3c7] border border-amber-200" onclick="updateColor('bg-[#fef3c7]', 'text-amber-800')"></button>
                        <button class="w-6 h-6 rounded-full bg-[#dcfce7] border border-emerald-200" onclick="updateColor('bg-[#dcfce7]', 'text-emerald-800')"></button>
                        <button class="w-6 h-6 rounded-full bg-[#f3e8ff] border border-purple-200" onclick="updateColor('bg-[#f3e8ff]', 'text-purple-800')"></button>
                        <button class="w-6 h-6 rounded-full bg-[#e5e7eb] border border-gray-300" onclick="updateColor('bg-[#e5e7eb]', 'text-gray-800')"></button>
                    </div>
                </div>

                <!-- Icon Selection (New) -->
                <div>
                    <label class="block text-[10px] font-bold text-brand-sage/60 mb-3 uppercase tracking-widest">é¸æ“‡è£é£¾åœ–ç¤º</label>
                    <div class="relative">
                        <select id="input-icon" onchange="updateIcon(this.value)" class="w-full p-3 bg-brand-paper border border-brand-sand rounded-xl focus:ring-1 focus:ring-brand-sage focus:outline-none text-sm text-brand-ink appearance-none cursor-pointer">
                            <option value="fa-ticket">ğŸ« ç¥¨æ ¹ Ticket</option>
                            <option value="fa-heart">â¤ æ„›å¿ƒ Heart</option>
                            <option value="fa-hand-holding-heart">ğŸ¤² çµ¦äºˆ Care</option>
                            <option value="fa-gift">ğŸ ç¦®ç‰© Gift</option>
                            <option value="fa-utensils">ğŸ½ é¤å…· Utensils</option>
                            <option value="fa-broom">ğŸ§¹ æƒæŠŠ Broom</option>
                            <option value="fa-plane">âœˆ é£›æ©Ÿ Plane</option>
                            <option value="fa-wind">ğŸƒ é¢¨ Wind</option>
                            <option value="fa-wine-glass">ğŸ· é…’æ¯ Wine</option>
                            <option value="fa-seedling">ğŸŒ± å¹¼è‹— Seedling</option>
                            <option value="fa-droplet">ğŸ’§ æ°´æ»´ Droplet</option>
                            <option value="fa-flag">ğŸš© æ——å¹Ÿ Flag</option>
                            <option value="fa-star">â­ æ˜Ÿæ˜Ÿ Star</option>
                            <option value="fa-music">ğŸµ éŸ³æ¨‚ Music</option>
                            <option value="fa-camera">ğŸ“· ç›¸æ©Ÿ Camera</option>
                        </select>
                        <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-brand-sage">
                            <i class="fa-solid fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>

                <!-- Text Inputs -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-[10px] font-bold text-brand-sage/60 mb-1.5 uppercase tracking-widest">æ¨™é¡Œ Title</label>
                        <input type="text" id="input-title" oninput="saveAndRefresh()" class="w-full p-3 bg-brand-paper border border-brand-sand rounded-xl focus:ring-1 focus:ring-brand-sage focus:outline-none text-sm text-brand-ink">
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-brand-sage/60 mb-1.5 uppercase tracking-widest">æè¿°å…§å®¹ Description</label>
                        <textarea id="input-desc" rows="2" oninput="saveAndRefresh()" class="w-full p-3 bg-brand-paper border border-brand-sand rounded-xl focus:ring-1 focus:ring-brand-sage focus:outline-none text-sm text-brand-ink leading-relaxed"></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-brand-sage/60 mb-1.5 uppercase tracking-widest">ç°½ç™¼äºº From</label>
                            <input type="text" id="input-from" oninput="saveAndRefresh()" class="w-full p-3 bg-brand-paper border border-brand-sand rounded-xl focus:ring-1 focus:ring-brand-sage focus:outline-none text-sm text-brand-ink">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-brand-sage/60 mb-1.5 uppercase tracking-widest">æŒæœ‰è€… To</label>
                            <input type="text" id="input-to" oninput="saveAndRefresh()" class="w-full p-3 bg-brand-paper border border-brand-sand rounded-xl focus:ring-1 focus:ring-brand-sage focus:outline-none text-sm text-brand-ink">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-bold text-brand-sage/60 mb-1.5 uppercase tracking-widest">ç¥¨è™Ÿ No.</label>
                            <input type="text" id="input-no" oninput="saveAndRefresh()" class="w-full p-3 bg-brand-paper border border-brand-sand rounded-xl focus:ring-1 focus:ring-brand-sage focus:outline-none text-sm text-brand-ink">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-brand-sage/60 mb-1.5 uppercase tracking-widest">æ•ˆæœŸ Valid Until</label>
                            <input type="text" id="input-date" oninput="saveAndRefresh()" class="w-full p-3 bg-brand-paper border border-brand-sand rounded-xl focus:ring-1 focus:ring-brand-sage focus:outline-none text-sm text-brand-ink">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-10 pt-6 border-t border-brand-sand grid grid-cols-1 sm:grid-cols-2 gap-3">
                <button onclick="downloadTicket()" id="download-btn" class="w-full bg-brand-ink hover:bg-black text-brand-paper font-bold py-3.5 px-4 rounded-xl shadow-md transition-all active:scale-95 flex justify-center items-center gap-2 text-xs tracking-widest disabled:opacity-50">
                    <i class="fa-solid fa-download"></i> åœ–ç‰‡å­˜æª”
                </button>
                <button onclick="shareTicket()" id="share-btn" class="w-full bg-brand-sage hover:bg-[#7a8f86] text-white font-bold py-3.5 px-4 rounded-xl shadow-md transition-all active:scale-95 flex justify-center items-center gap-2 text-xs tracking-widest disabled:opacity-50">
                    <i class="fa-solid fa-paper-plane"></i> å‚³é€å¿ƒæ„
                </button>
            </div>
        </section>

        <!-- Preview Section -->
        <section id="preview-section" class="w-full lg:w-2/3 flex flex-col items-center justify-start bg-brand-sand/20 rounded-3xl p-6 sm:p-12 border border-dashed border-brand-sand min-h-[500px] relative overflow-hidden">
            <h3 class="text-brand-sage/40 font-bold mb-8 uppercase tracking-[0.4em] text-[10px]">Instant Preview</h3>
            
            <div id="scale-wrapper" class="origin-top transition-transform duration-300">
                <!-- Ticket Container (Generic Design) -->
                <div id="ticket-container" class="relative w-[600px] shadow-2xl rounded-2xl overflow-hidden">
                    <div id="ticket-body" class="flex w-full h-72 bg-white rounded-2xl overflow-hidden relative">
                        
                        <!-- Notches -->
                        <div class="absolute top-1/2 -left-4 w-8 h-8 bg-brand-paper rounded-full transform -translate-y-1/2 z-10 border-r border-black/5"></div>
                        <div class="absolute top-1/2 -right-4 w-8 h-8 bg-brand-paper rounded-full transform -translate-y-1/2 z-10 border-l border-black/5"></div>

                        <!-- Left Main Part -->
                        <div class="flex-1 p-10 flex flex-col justify-between relative border-r border-dashed border-black/10">
                            <div class="flex justify-between items-start">
                                <div class="text-[10px] font-black uppercase tracking-[0.2em] opacity-40 text-brand-ink" id="preview-header">TICKET NO. 000000</div>
                                <div class="text-[10px] font-bold opacity-30 tracking-widest uppercase" id="ticket-top-right">Voucher Official</div>
                            </div>

                            <div class="flex flex-row items-center gap-6 my-4">
                                <div class="bg-white/40 w-16 h-16 rounded-full flex items-center justify-center flex-shrink-0 backdrop-blur-sm border border-white/50">
                                    <!-- Updated Icon Structure for alignment stability -->
                                    <i id="preview-main-icon" class="fa-solid fa-ticket text-3xl opacity-80 fa-icon-fix leading-none"></i>
                                </div>
                                <div class="flex-1">
                                    <h2 id="preview-title" class="text-4xl font-serif text-brand-ink leading-none tracking-tight">å…Œæ›åˆ¸æ¨™é¡Œ</h2>
                                    <p class="text-[10px] font-black opacity-30 mt-2 tracking-[0.3em] uppercase">Voucher Invitation</p>
                                </div>
                            </div>

                            <div class="bg-white/40 rounded-xl p-4 backdrop-blur-sm border border-white/30">
                                <p id="preview-desc" class="text-brand-ink/80 font-medium text-sm leading-relaxed italic">
                                    åœ¨æ­¤è¼¸å…¥æƒ³è¦æ‰¿è«¾çš„å…§å®¹...
                                </p>
                            </div>
                            
                            <div class="flex justify-between items-end mt-4 text-[11px] font-bold text-brand-ink/60 tracking-wider">
                                <div class="flex items-center gap-2"><span class="opacity-40">FROM:</span> <span id="preview-from">ç°½ç™¼äºº</span></div>
                                <div class="flex items-center gap-2"><span class="opacity-40">TO:</span> <span id="preview-to">æŒæœ‰è€…</span></div>
                            </div>
                        </div>

                        <!-- Right Stub Part -->
                        <div class="w-44 flex flex-col justify-center items-center p-6 bg-black/5 relative">
                            <!-- Generic Barcode -->
                            <div class="w-full flex justify-center items-center opacity-40 mb-6 grayscale">
                                <div class="w-full h-12 flex items-end gap-[1px]">
                                    <div class="flex-grow h-full bg-brand-ink"></div>
                                    <div class="flex-grow h-3/4 bg-brand-ink"></div>
                                    <div class="flex-grow h-full bg-brand-ink"></div>
                                    <div class="flex-grow h-1/2 bg-brand-ink"></div>
                                    <div class="flex-grow h-full bg-brand-ink"></div>
                                    <div class="flex-grow h-2/3 bg-brand-ink"></div>
                                    <div class="flex-grow h-full bg-brand-ink"></div>
                                    <div class="flex-grow h-1/3 bg-brand-ink"></div>
                                </div>
                            </div>
                            
                            <div class="text-center relative z-10">
                                <p class="text-[9px] uppercase tracking-[0.3em] opacity-40 font-black mb-1">Expiration</p>
                                <h4 id="preview-date" class="text-sm font-black text-brand-ink leading-tight">æ°¸ä¹…æœ‰æ•ˆ</h4>
                            </div>

                            <div class="mt-8 opacity-10">
                                <i class="fa-solid fa-stamp text-5xl transform -rotate-12"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <p class="mt-8 text-[10px] text-brand-sage/40 tracking-widest uppercase">
                Designed for Shared Moments
            </p>
        </section>
    </main>

    <!-- Footer -->
    <footer class="mt-16 text-center text-brand-sage/60 text-[10px] py-8 border-t border-brand-sand tracking-widest">
        <p>2026 å¸¸æº«ç·¨é›†æ‰€ Ambient Edit Studio.</p>
        <div class="mt-4 flex justify-center gap-6">
            <a href="https://line.me/R/ti/p/@890mvlvl" target="_blank" class="hover:text-brand-ink transition-colors">LINE@</a>
            <a href="https://www.instagram.com/ambientedit_" target="_blank" class="hover:text-brand-ink transition-colors">INSTAGRAM</a>
        </div>
    </footer>

    <!-- Hidden Capture Container -->
    <div id="capture-container"></div>

    <!-- Result Modal -->
    <div id="result-modal" class="fixed inset-0 bg-brand-ink/90 z-50 hidden flex justify-center items-center p-4 backdrop-blur-md">
        <div class="bg-brand-paper rounded-3xl max-w-md w-full p-8 flex flex-col items-center shadow-soft relative modal-enter" id="modal-content">
            <button onclick="closeModal()" class="absolute top-6 right-6 text-brand-sage hover:text-brand-ink transition-colors">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
            
            <div class="text-center mb-6">
                <div class="w-12 h-12 bg-brand-sage/10 text-brand-sage rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fa-solid fa-check text-xl"></i>
                </div>
                <h3 class="text-lg font-serif text-brand-ink">ç¥¨åˆ¸å·²å°±ç·’</h3>
                <p class="text-xs text-brand-sage mt-2">è«‹é•·æŒ‰åœ–ç‰‡å„²å­˜ï¼Œæˆ–ç›´æ¥åˆ†äº«çµ¦å°æ–¹ã€‚</p>
            </div>

            <div class="w-full bg-white rounded-xl p-2 mb-6 shadow-sm border border-brand-sand">
                <img id="generated-image" class="max-w-full h-auto rounded" alt="Generated Ticket">
            </div>

            <button onclick="closeModal()" class="w-full bg-brand-ink text-brand-paper font-bold py-3.5 rounded-xl hover:bg-black transition-colors text-xs tracking-widest">
                è¿”å›ç·¨è¼¯
            </button>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'ambient_voucher_data_v4';
        const elements = {
            inputTitle: document.getElementById('input-title'),
            inputDesc: document.getElementById('input-desc'),
            inputFrom: document.getElementById('input-from'),
            inputTo: document.getElementById('input-to'),
            inputNo: document.getElementById('input-no'),
            inputDate: document.getElementById('input-date'),
            inputIcon: document.getElementById('input-icon'),
            previewTitle: document.getElementById('preview-title'),
            previewDesc: document.getElementById('preview-desc'),
            previewFrom: document.getElementById('preview-from'),
            previewTo: document.getElementById('preview-to'),
            previewDate: document.getElementById('preview-date'),
            previewHeader: document.getElementById('preview-header'),
            ticketBody: document.getElementById('ticket-body'),
            previewIcon: document.getElementById('preview-main-icon'),
            modal: document.getElementById('result-modal'),
            modalContent: document.getElementById('modal-content'),
            loading: document.getElementById('loading-overlay')
        };

        const templates = {
            'bf': {
                title: 'è¶…ç´šç”·å‹åˆ¸',
                desc: 'æ†‘æ­¤åˆ¸å¯å…Œæ›ä¸€æ—¥å®Œç¾ç”·å‹é«”é©—ï¼ŒåŒ…å«æ‹åŒ…ã€å‰è¦èˆ‡ç„¡é™è€å¿ƒã€‚',
                from: 'æ„›å¦³çš„å¯¶å¯¶', to: 'æœ€ç¾çš„å¥³å‹', no: '5201314', date: 'æ°¸ä¹…æœ‰æ•ˆ',
                color: 'bg-[#fce7f3]', text: 'text-pink-800', icon: 'fa-heart'
            },
            'massage': {
                title: 'å°ˆå±¬æŒ‰æ‘©åˆ¸',
                desc: 'æ†‘æ­¤åˆ¸å¯å…Œæ›è‚©é ¸/å…¨èº«æŒ‰æ‘© 30 åˆ†é˜ï¼ŒåŠ›åº¦èˆ‡æ‰‹æ³•ç”±æ‚¨æŒ‡å®šã€‚',
                from: 'å°ˆå±¬æŠ€å¸«', to: 'å°Šè²´å®¢æˆ¶', no: 'SPA-999', date: 'æœ¬æœˆæœ‰æ•ˆ',
                color: 'bg-[#dcfce7]', text: 'text-emerald-800', icon: 'fa-hand-holding-heart'
            },
            'food': {
                title: 'å¤§é¤è«‹å®¢åˆ¸',
                desc: 'æ†‘æ­¤åˆ¸å¯æŒ‡å®šä»»ä½•ä¸€é–“é¤å»³ï¼Œæˆ‘è²·å–®ï¼(é ç®—è«‹æ‰‹ä¸‹ç•™æƒ…)',
                from: 'ä½ çš„é£¯ç¥¨', to: 'ç¾é£Ÿå®¶', no: 'YUMMY888', date: 'æœ¬æœˆæœ‰æ•ˆ',
                color: 'bg-[#fef3c7]', text: 'text-amber-800', icon: 'fa-utensils'
            },
            'chores': {
                title: 'å…åšå®¶äº‹åˆ¸',
                desc: 'æ†‘æ­¤åˆ¸å¯æŠµéŠ·ä¸€æ¬¡å®¶äº‹ï¼ˆæ´—ç¢—ã€å€’åƒåœ¾ã€æƒåœ°ï¼‰ï¼Œé€šé€šäº¤çµ¦æˆ‘ã€‚',
                from: 'å®¶äº‹å°ç²¾éˆ', to: 'ä¸€å®¶ä¹‹ä¸»', no: 'CLEAN001', date: 'ä»Šæ—¥é™å®š',
                color: 'bg-[#e5e7eb]', text: 'text-gray-800', icon: 'fa-broom'
            },
            'trip': {
                title: 'èªªèµ°å°±èµ°åˆ¸',
                desc: 'æ†‘æ­¤åˆ¸å¯å…Œæ›ä¸€æ¬¡é€±æœ«å°æ—…è¡Œï¼Œåœ°é»ç”±ä½ æ±ºå®šï¼Œæˆ‘è² è²¬è¦åŠƒã€‚',
                from: 'å°ˆå±¬å¸æ©Ÿ', to: 'æ—…ä¼´', no: 'TRIP-GO', date: 'è¿‘æœŸå‡ºç™¼',
                color: 'bg-[#f3e8ff]', text: 'text-purple-800', icon: 'fa-plane'
            },
            'breakup': {
                title: 'åˆ†æ‰‹å®‰æ…°åˆ¸',
                desc: 'æ†‘æ­¤åˆ¸å¯å…Œæ›ã€Œç„¡é™æ¬¡åƒåœ¾è©±å‚¾è½ã€èˆ‡ã€Œä¸å•åŸå› çš„æ“æŠ±ã€ã€‚ä½ ä¸å¿…ç¨è‡ªæ‰¿æ“”ã€‚',
                from: 'éµæ¡¿å¥½å‹', to: 'å€¼å¾—æ›´å¥½çš„ä½ ', no: 'HEAL-01', date: 'ä½ éœ€è¦æ™‚',
                color: 'bg-[#fdfbf7]', text: 'text-brand-clay', icon: 'fa-wind'
            },
            'drink': {
                title: 'é…’ç²¾æ¶ˆæ„åˆ¸',
                desc: 'æ†‘æ­¤åˆ¸å¯å…Œæ›ä¸€æ™šä¸é†‰ä¸æ­¸ã€‚é…’éŒ¢æˆ‘å‡ºï¼Œæ•…äº‹ä½ èªªï¼Œåäº†æˆ‘æ¸…ã€‚',
                from: 'é™ªå–å°ˆå“¡', to: 'é…’é¬¼æˆ°å‹', no: 'BEER-99', date: 'ä»Šæ™šæœ‰æ•ˆ',
                color: 'bg-[#e5e7eb]', text: 'text-brand-ink', icon: 'fa-wine-glass'
            },
            'restart': {
                title: 'é‡æ–°é–‹å§‹åˆ¸',
                desc: 'æ†‘æ­¤åˆ¸å¯å…Œæ›ã€Œå‰ªé«®ã€è²·æ–°è¡£ã€æ›å¿ƒæƒ…ã€ä¸€æ—¥è¡Œç¨‹ã€‚æ˜¨æ—¥ç¨®ç¨®ï¼Œä»Šæ—¥å·²æ­»ã€‚',
                from: 'è½‰èº«å°å¹«æ‰‹', to: 'å…¨æ–°çš„è‡ªå·±', no: 'NEW-LIFE', date: 'ç¾åœ¨é–‹å§‹',
                color: 'bg-[#dcfce7]', text: 'text-brand-sage', icon: 'fa-seedling'
            },
            'cry': {
                title: 'ç„¡ä¸Šé™é™ªå“­åˆ¸',
                desc: 'æ†‘æ­¤åˆ¸å¯å…Œæ›è¡›ç”Ÿç´™ç„¡é™ä¾›æ‡‰åŠã€Œæˆ‘å°±åœ¨é€™è£¡ã€çš„é™ªä¼´ã€‚å“­å®Œæˆ‘å€‘å†èªªã€‚',
                from: 'è¡›ç”Ÿç´™å•†', to: 'æ„›å“­åŒ…', no: 'TEAR-88', date: 'å“­å®Œç‚ºæ­¢',
                color: 'bg-[#e0f2fe]', text: 'text-blue-800', icon: 'fa-droplet'
            },
            'forgive': {
                title: 'ç„¡æ¢ä»¶åŸè«’',
                desc: 'ç„¡è«–æˆ‘çŠ¯äº†ä»€éº¼å°éŒ¯ï¼Œå‡ºç¤ºæ­¤åˆ¸ï¼Œå¿…é ˆç„¡æ¢ä»¶åŸè«’æˆ‘ä¸€æ¬¡ï¼',
                from: 'çŸ¥éŒ¯çš„äºº', to: 'å¯¬å®¹çš„ä½ ', no: 'SORRY-1', date: 'æ°¸ä¹…æœ‰æ•ˆ',
                color: 'bg-[#e0f2fe]', text: 'text-blue-800', icon: 'fa-flag'
            }
        };

        let state = { bgColor: 'bg-white', textColor: 'text-brand-ink', icon: 'fa-ticket' };

        window.onload = () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const data = JSON.parse(saved);
                Object.keys(data).forEach(key => {
                    // Skip if key is color/icon object wrapper, handle separately
                    if (elements[`input${key.charAt(0).toUpperCase() + key.slice(1)}`]) {
                        elements[`input${key.charAt(0).toUpperCase() + key.slice(1)}`].value = data[key];
                    }
                });
                
                // Restore icon explicitly
                if(data.icon) {
                    state.icon = data.icon;
                    if(elements.inputIcon) elements.inputIcon.value = data.icon;
                    updateIcon(data.icon, false); // false to avoid double save
                }

                if(data.color) updateColor(data.color.bg, data.color.text, false);
            } else {
                applyTemplate('bf');
            }
            saveAndRefresh();
            resizePreview();
            
            document.fonts.ready.then(() => {
                console.log('Fonts loaded');
            });
        };

        function saveAndRefresh() {
            const data = {
                title: elements.inputTitle.value,
                desc: elements.inputDesc.value,
                from: elements.inputFrom.value,
                to: elements.inputTo.value,
                no: elements.inputNo.value,
                date: elements.inputDate.value,
                icon: state.icon,
                color: { bg: state.bgColor, text: state.textColor }
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            
            elements.previewTitle.textContent = data.title || 'å…Œæ›åˆ¸æ¨™é¡Œ';
            elements.previewDesc.textContent = data.desc || 'è«‹è¼¸å…¥å…§å®¹æè¿°...';
            elements.previewFrom.textContent = data.from || 'ç°½ç™¼äºº';
            elements.previewTo.textContent = data.to || 'æŒæœ‰è€…';
            elements.previewDate.textContent = data.date || 'æœ‰æ•ˆæ—¥æœŸ';
            elements.previewHeader.textContent = `TICKET NO. ${data.no || '000000'}`;
        }

        function updateColor(bgClass, textClass, save = true) {
            elements.ticketBody.className = `flex w-full h-72 rounded-2xl overflow-hidden relative ${bgClass}`;
            
            const colorTargets = [elements.previewTitle, elements.previewDate, elements.previewHeader];
            colorTargets.forEach(el => {
                el.className = el.className.replace(/text-\w+-\d+/g, textClass);
                el.className = el.className.replace(/text-brand-\w+/g, textClass);
                if(!el.className.includes(textClass)) el.classList.add(textClass);
            });
            
            const icon = elements.previewIcon;
            icon.className = icon.className.replace(/text-\w+-\d+/g, textClass);
            icon.className = icon.className.replace(/text-brand-\w+/g, textClass);
            if(!icon.className.includes(textClass)) icon.classList.add(textClass);

            state.bgColor = bgClass;
            state.textColor = textClass;
            if(save) saveAndRefresh();
        }

        function updateIcon(iconClass, save = true) {
            // Remove existing fa-* classes from preview icon
            const icon = elements.previewIcon;
            const classList = icon.className.split(' ');
            const newClassList = classList.filter(c => !c.startsWith('fa-'));
            
            icon.className = newClassList.join(' ');
            icon.classList.add('fa-solid', iconClass);
            
            // Sync select input if updated via template
            if(elements.inputIcon.value !== iconClass) {
                elements.inputIcon.value = iconClass;
            }
            
            state.icon = iconClass;
            if(save) saveAndRefresh();
        }

        function applyTemplate(key) {
            const t = templates[key];
            elements.inputTitle.value = t.title;
            elements.inputDesc.value = t.desc;
            elements.inputFrom.value = t.from;
            elements.inputTo.value = t.to;
            elements.inputNo.value = t.no;
            elements.inputDate.value = t.date;
            
            updateIcon(t.icon, false);
            updateColor(t.color, t.text, false);
            saveAndRefresh();
        }

        function resizePreview() {
            const container = document.getElementById('preview-section');
            const wrapper = document.getElementById('scale-wrapper');
            if(!container || !wrapper) return;
            const availableWidth = container.offsetWidth - 48;
            let scale = availableWidth / 600;
            if (scale > 1) scale = 1;
            wrapper.style.transform = `scale(${scale})`;
            wrapper.style.height = `${288 * scale}px`;
        }

        window.addEventListener('resize', resizePreview);

        async function generateVoucherCanvas() {
            elements.loading.style.display = 'flex';
            
            const captureArea = document.getElementById('capture-container');
            const source = document.getElementById('ticket-container');
            
            captureArea.innerHTML = '';
            const clone = source.cloneNode(true);
            
            clone.style.transform = 'none';
            clone.style.position = 'relative';
            clone.style.margin = '0';
            clone.style.boxShadow = 'none';
            
            captureArea.appendChild(clone);
            
            await document.fonts.ready;
            
            // Give icon a moment to settle style-wise if needed
            await new Promise(resolve => setTimeout(resolve, 50));

            try {
                const canvas = await html2canvas(clone, {
                    scale: 2,
                    backgroundColor: null,
                    useCORS: true,
                    allowTaint: true,
                    logging: false,
                    width: 600,
                    height: 288,
                    // Force text rendering to be precise
                    onclone: (clonedDoc) => {
                        const icons = clonedDoc.querySelectorAll('.fa-icon-fix');
                        icons.forEach(icon => {
                            icon.style.lineHeight = '1';
                            icon.style.display = 'inline-block';
                            icon.style.textAlign = 'center';
                        });
                    }
                });
                
                captureArea.innerHTML = '';
                elements.loading.style.display = 'none';
                return canvas;
            } catch (err) {
                console.error('Generation failed:', err);
                elements.loading.style.display = 'none';
                return null;
            }
        }

        async function downloadTicket() {
            const canvas = await generateVoucherCanvas();
            if (!canvas) return;
            
            const img = canvas.toDataURL('image/png');
            document.getElementById('generated-image').src = img;
            elements.modal.classList.remove('hidden');
            setTimeout(() => elements.modalContent.classList.add('modal-active'), 10);
        }

        async function shareTicket() {
            const canvas = await generateVoucherCanvas();
            if (!canvas) return;
            
            canvas.toBlob(async (blob) => {
                const file = new File([blob], 'ambient-voucher.png', { type: 'image/png' });
                
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: 'é€ä½ ä¸€å¼µå¸¸æº«å…Œæ›åˆ¸',
                            text: 'é€™æ˜¯ä¸€ä»½å¿ƒæ„ï¼Œè«‹æŸ¥æ”¶ã€‚'
                        });
                    } catch (err) {
                        console.log('Share canceled or failed');
                        const img = canvas.toDataURL('image/png');
                        document.getElementById('generated-image').src = img;
                        elements.modal.classList.remove('hidden');
                        setTimeout(() => elements.modalContent.classList.add('modal-active'), 10);
                    }
                } else {
                    const img = canvas.toDataURL('image/png');
                    document.getElementById('generated-image').src = img;
                    elements.modal.classList.remove('hidden');
                    setTimeout(() => elements.modalContent.classList.add('modal-active'), 10);
                }
            }, 'image/png');
        }

        function closeModal() {
            elements.modalContent.classList.remove('modal-active');
            setTimeout(() => elements.modal.classList.add('hidden'), 300);
        }
    </script>
</body>
</html>
