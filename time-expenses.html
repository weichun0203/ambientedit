<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Title -->
    <title>常溫時光編集｜Ambient Time Tracker</title>
    
    <!-- Meta 與 JSON-LD -->
    <meta name="description" content="常溫時光編集，一款溫暖的時間紀錄工具，幫助你覺察與分析日常的時間流向。">
    <meta property="og:title" content="常溫時光編集｜Ambient Time Tracker">
    <meta property="og:image" content="https://weichun0203.github.io/ambientedit/assets/og-image.jpg">
    
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "常溫時光編集",
      "alternateName": "Ambient Time Tracker",
      "description": "紀錄並分析每日時間分配的溫暖工具。",
      "applicationCategory": "Productivity",
      "operatingSystem": "All",
      "author": {
        "@type": "Organization",
        "name": "常溫編集所 Ambient Edit Studio"
      }
    }
    </script>

    <!-- GA4 追蹤碼 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-2F079YMSFW"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-2F079YMSFW');
    </script>

    <!-- 字體與樣式庫 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Tailwind 設定 (品牌色) -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            paper: '#fdfbf7',
                            ink: '#4a4a4a',
                            sage: '#8da399',
                            sageLight: '#eef2f0',
                            clay: '#d4a59a',
                            sand: '#e6e2dd',
                            white: '#ffffff',
                        }
                    },
                    fontFamily: {
                        serif: ['"Noto Serif TC"', 'serif'],
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    },
                    boxShadow: {
                        soft: '0 4px 20px -2px rgba(74, 74, 74, 0.05)',
                        card: '0 2px 10px rgba(0, 0, 0, 0.02)',
                        inner: 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.05)',
                        modal: '0 20px 50px -10px rgba(0, 0, 0, 0.1)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                        'scale-in': 'scaleIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.8)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        .bg-noise {
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
        }
        body {
            background-color: #fdfbf7;
            color: #4a4a4a;
            -webkit-font-smoothing: antialiased;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e6e2dd; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #d4a59a; }
        
        /* Tab Active State */
        .tab-active {
            background-color: #8da399; /* brand-sage */
            color: white;
            box-shadow: 0 4px 12px rgba(141, 163, 153, 0.3);
        }
        .tab-inactive {
            background-color: transparent;
            color: #4a4a4a;
            border: 1px solid #e6e2dd;
        }
        .tab-inactive:hover {
            border-color: #8da399;
            color: #8da399;
        }
        /* Utility for hiding elements but keeping layout */
        .hidden-visually {
            display: none !important;
        }
    </style>
</head>
<body class="bg-noise min-h-screen flex flex-col font-sans selection:bg-brand-sage selection:text-white relative">

    <!-- Success Overlay (Hidden by default) -->
    <div id="successOverlay" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-brand-paper/80 backdrop-blur-md transition-opacity duration-500 opacity-0">
        <div class="text-center animate-scale-in">
            <div class="w-20 h-20 mx-auto bg-brand-sage rounded-full flex items-center justify-center shadow-lg shadow-brand-sage/30 mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <h3 class="font-serif text-2xl font-bold text-brand-ink mb-2 tracking-widest">時光已收藏</h3>
            <p class="text-brand-ink/50 text-sm font-sans tracking-wide">Time Collected</p>
        </div>
    </div>

    <!-- Confirm Modal (New Feature) -->
    <div id="confirmModal" class="fixed inset-0 z-[70] hidden flex items-center justify-center bg-brand-ink/20 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-brand-paper w-full max-w-sm mx-6 rounded-2xl shadow-modal p-6 border border-brand-white relative animate-slide-up bg-noise">
            <div class="text-center mb-6">
                <div id="confirmIcon" class="w-12 h-12 mx-auto rounded-full flex items-center justify-center mb-4 transition-colors">
                    <!-- Icon will be injected by JS -->
                </div>
                <h3 id="confirmTitle" class="font-serif text-xl font-bold text-brand-ink mb-2">確認動作</h3>
                <p id="confirmMessage" class="text-sm text-brand-ink/60 font-sans leading-relaxed">請確認是否執行此動作？</p>
            </div>
            <div class="flex gap-3">
                <button onclick="closeConfirmModal()" id="confirmCancelBtn" class="flex-1 py-2.5 rounded-lg border border-brand-sand text-brand-ink/60 font-bold text-sm hover:bg-brand-sand/20 transition-all">
                    取消
                </button>
                <button id="confirmActionBtn" class="flex-1 py-2.5 rounded-lg text-white font-bold text-sm transition-all shadow-md">
                    確認執行
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Modal (Hidden by default) -->
    <div id="editModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-brand-ink/20 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-brand-paper w-full max-w-md mx-4 rounded-2xl shadow-modal p-8 border border-brand-white relative animate-slide-up bg-noise max-h-[90vh] overflow-y-auto">
            <button onclick="closeEditModal()" class="absolute top-4 right-4 text-brand-ink/30 hover:text-brand-clay transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            
            <h3 class="font-serif text-xl font-bold text-brand-ink mb-6 text-center">編輯時光紀錄</h3>
            
            <form id="editForm" class="space-y-5">
                <input type="hidden" id="editId">
                
                <div class="space-y-1">
                    <label class="text-xs font-bold text-brand-ink/50 tracking-wider">事項名稱</label>
                    <input type="text" id="editTaskName" required class="w-full bg-white border border-brand-sand rounded-lg px-4 py-2 focus:outline-none focus:border-brand-sage transition-all text-brand-ink">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-brand-ink/50 tracking-wider">分類</label>
                        <select id="editCategory" class="w-full bg-white border border-brand-sand rounded-lg px-4 py-2 focus:outline-none focus:border-brand-sage transition-all text-brand-ink">
                             <option value="工作">工作 Work</option>
                             <option value="學習">學習 Growth</option>
                             <option value="休息">休息 Rest</option>
                             <option value="生活">生活 Life</option>
                             <option value="浪費">浪費 Waste</option>
                        </select>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-bold text-brand-ink/50 tracking-wider">時間 (min)</label>
                        <input type="number" id="editDuration" min="1" required class="w-full bg-white border border-brand-sand rounded-lg px-4 py-2 focus:outline-none focus:border-brand-sage transition-all text-brand-ink">
                    </div>
                </div>

                <!-- New Date & Time Inputs -->
                <div class="border-t border-brand-sand/50 pt-4 mt-2">
                    <p class="text-xs font-bold text-brand-sage mb-3 tracking-widest uppercase">時光回溯</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-brand-ink/50 tracking-wider">日期</label>
                            <input type="date" id="editDate" required class="w-full bg-white border border-brand-sand rounded-lg px-4 py-2 focus:outline-none focus:border-brand-sage transition-all text-brand-ink font-mono text-sm">
                        </div>
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-brand-ink/50 tracking-wider">時間</label>
                            <input type="time" id="editTime" required class="w-full bg-white border border-brand-sand rounded-lg px-4 py-2 focus:outline-none focus:border-brand-sage transition-all text-brand-ink font-mono text-sm">
                        </div>
                    </div>
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeEditModal()" class="flex-1 py-2.5 rounded-lg border border-brand-sand text-brand-ink/60 font-bold text-sm hover:bg-brand-sand/20 transition-all">
                        取消
                    </button>
                    <button type="submit" class="flex-1 py-2.5 rounded-lg bg-brand-sage text-white font-bold text-sm hover:bg-brand-ink transition-all shadow-md shadow-brand-sage/20">
                        儲存變更
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Header Section -->
    <header class="w-full max-w-5xl mx-auto pt-16 pb-6 px-6 lg:px-8">
        <div class="flex flex-col md:flex-row items-end justify-between relative border-b border-brand-sand pb-6">
            <div class="hidden md:block w-32"></div>
            <div class="text-center w-full md:w-auto mx-auto relative z-10">
                <p class="text-brand-sage font-bold tracking-[0.2em] text-xs mb-3 uppercase">Ambient Edit Studio</p>
                <h1 class="text-4xl md:text-5xl font-serif font-bold text-brand-ink mb-4 tracking-wider leading-tight">
                    常溫時光編集
                </h1>
                <p class="text-brand-ink/60 font-serif italic text-sm md:text-base tracking-wide">
                    「將時間輕輕摺疊，收藏在日子的扉頁裡。」
                </p>
            </div>
            <div class="mt-8 md:mt-0 w-full md:w-auto flex justify-center md:justify-end">
                <a href="https://weichun0203.github.io/ambientedit/" 
                   class="group inline-flex items-center px-5 py-2.5 rounded-full border border-brand-sand hover:border-brand-sage hover:bg-white transition-all duration-500 shadow-sm hover:shadow-soft bg-white/40 backdrop-blur-md"
                   aria-label="返回常溫首頁"
                   style="text-decoration: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-brand-sage group-hover:text-brand-ink transition-colors duration-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                    <span class="ml-2 text-xs font-bold tracking-widest text-brand-sage group-hover:text-brand-ink transition-colors duration-300">
                        常溫首頁
                    </span>
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow w-full max-w-5xl mx-auto px-6 lg:px-8 py-8">
        
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
            <!-- 左側：輸入與列表區 (佔 7 欄) -->
            <div class="lg:col-span-7 space-y-8">
                
                <!-- Input Card -->
                <section class="bg-white/80 backdrop-blur-sm rounded-2xl p-8 shadow-soft border border-brand-white hover:border-brand-sand transition-colors duration-500">
                    <div class="flex justify-between items-baseline mb-6">
                        <h2 class="font-serif text-2xl font-bold text-brand-ink">紀錄當下</h2>
                        <span class="text-xs text-brand-sage font-bold tracking-widest uppercase">New Entry</span>
                    </div>
                    
                    <form id="timeForm" class="space-y-6">
                        <div class="group">
                            <label class="block text-xs font-bold text-brand-ink/50 mb-2 tracking-wider group-focus-within:text-brand-sage transition-colors">事項名稱</label>
                            <input type="text" id="taskName" placeholder="例如：閱讀品牌書籍、整理花園..." required
                                   class="w-full bg-brand-paper/50 border-b-2 border-brand-sand rounded-t-lg px-4 py-3 focus:outline-none focus:border-brand-sage focus:bg-white transition-all placeholder:text-brand-ink/20 text-brand-ink text-lg font-serif">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-6">
                            <div class="group">
                                <label class="block text-xs font-bold text-brand-ink/50 mb-2 tracking-wider group-focus-within:text-brand-sage transition-colors">分類</label>
                                <div class="relative">
                                    <select id="category" class="appearance-none w-full bg-brand-paper/50 border-b-2 border-brand-sand rounded-t-lg px-4 py-3 focus:outline-none focus:border-brand-sage focus:bg-white transition-all text-brand-ink cursor-pointer">
                                        <option value="工作">工作 Work</option>
                                        <option value="學習">學習 Growth</option>
                                        <option value="休息">休息 Rest</option>
                                        <option value="生活">生活 Life</option>
                                        <option value="浪費">浪費 Waste</option>
                                    </select>
                                    <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-brand-ink/40">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            <div class="group">
                                <label class="block text-xs font-bold text-brand-ink/50 mb-2 tracking-wider group-focus-within:text-brand-sage transition-colors">時間長度 (分鐘)</label>
                                <input type="number" id="duration" placeholder="30" min="1" required
                                   class="w-full bg-brand-paper/50 border-b-2 border-brand-sand rounded-t-lg px-4 py-3 focus:outline-none focus:border-brand-sage focus:bg-white transition-all placeholder:text-brand-ink/20 text-brand-ink font-mono">
                            </div>
                        </div>

                        <div class="pt-2">
                            <button type="submit" 
                                    class="w-full bg-brand-sage text-white font-bold py-3.5 rounded-xl hover:bg-brand-ink hover:scale-[1.01] active:scale-[0.99] transition-all duration-300 shadow-lg shadow-brand-sage/20 tracking-widest flex justify-center items-center gap-2">
                                <span>寫入時光</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                            </button>
                            
                            <div class="mt-6 text-center border-t border-brand-sand/30 pt-4">
                                <p class="text-xs text-brand-clay/80 font-serif italic tracking-wider leading-relaxed">
                                    「有意識的休息是生活的留白，<br class="md:hidden">無意識的空白才是時間的浪費。」
                                </p>
                            </div>
                        </div>
                    </form>
                </section>

                <!-- List Section (With Integrated View Switcher) -->
                <section class="relative">
                    <!-- Integrated Header & Tabs -->
                    <div class="flex flex-col md:flex-row md:justify-between md:items-end mb-6 gap-4">
                        <div class="flex-1">
                            <h2 id="listTitle" class="font-serif text-2xl font-bold text-brand-ink">今日足跡</h2>
                            <p id="listSubtitle" class="text-xs text-brand-ink/40 mt-1">Today's Footprint</p>
                        </div>
                        
                        <!-- View Switcher Grouped with Header -->
                        <div class="flex items-center gap-4">
                             <div class="bg-white/50 backdrop-blur-sm p-1 rounded-full border border-brand-sand shadow-inner flex space-x-1">
                                <button onclick="switchView('day')" id="btn-day" class="px-4 py-1.5 rounded-full text-xs font-bold tracking-widest transition-all duration-300 tab-active">
                                    今日
                                </button>
                                <button onclick="switchView('week')" id="btn-week" class="px-4 py-1.5 rounded-full text-xs font-bold tracking-widest transition-all duration-300 tab-inactive">
                                    本週
                                </button>
                                <button onclick="switchView('month')" id="btn-month" class="px-4 py-1.5 rounded-full text-xs font-bold tracking-widest transition-all duration-300 tab-inactive">
                                    本月
                                </button>
                            </div>
                            
                            <!-- Export CSV Button (Triggers Modal) -->
                            <button onclick="askExport()" class="text-brand-ink/30 hover:text-brand-sage transition-colors p-2 rounded-full hover:bg-brand-sand/20" title="匯出 CSV">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div id="recordList" class="space-y-6 max-h-[600px] overflow-y-auto pr-2 pb-4 scroll-smooth">
                        <!-- Content will be injected by JS -->
                    </div>
                </section>
            </div>

            <!-- 右側：圖表與洞察 (佔 5 欄) -->
            <div class="lg:col-span-5 space-y-8">
                
                <!-- Summary Card -->
                <section class="bg-brand-ink text-brand-paper rounded-2xl p-6 shadow-xl shadow-brand-ink/10 flex justify-between items-center relative overflow-hidden transition-all duration-500">
                    <div class="relative z-10">
                        <p id="summaryTitle" class="text-brand-sage text-xs font-bold tracking-widest mb-1">今日專注總計</p>
                        <p class="text-4xl font-serif font-bold" id="totalTimeDisplay">0 <span class="text-sm font-sans font-normal opacity-60">min</span></p>
                    </div>
                    <div class="relative z-10 text-right">
                         <p class="text-xs opacity-50 mb-1">紀錄筆數</p>
                         <p class="text-xl font-bold" id="totalCountDisplay">0</p>
                    </div>
                    <div class="absolute -right-6 -bottom-10 w-32 h-32 bg-brand-sage/10 rounded-full blur-2xl"></div>
                </section>

                <!-- Radar Chart Card -->
                <section class="bg-white/60 backdrop-blur-sm rounded-2xl p-6 shadow-soft border border-brand-sand">
                    <div class="mb-4 text-center">
                        <h2 class="font-serif text-lg font-bold text-brand-ink">生活平衡</h2>
                        <div class="h-0.5 w-8 bg-brand-sage mx-auto mt-2 opacity-50"></div>
                    </div>
                    <div class="relative h-64 w-full">
                        <canvas id="radarChart"></canvas>
                    </div>
                </section>

                <!-- Bar Chart Card -->
                <section class="bg-white/60 backdrop-blur-sm rounded-2xl p-6 shadow-soft border border-brand-sand">
                    <div class="mb-4 text-center">
                        <h2 class="font-serif text-lg font-bold text-brand-ink">時數分佈</h2>
                        <div class="h-0.5 w-8 bg-brand-clay mx-auto mt-2 opacity-50"></div>
                    </div>
                    <div class="relative h-48 w-full">
                        <canvas id="barChart"></canvas>
                    </div>
                </section>

            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="mt-12 py-8 border-t border-brand-sand/30 text-center bg-white/30">
        <p class="text-xs text-brand-ink/40 font-sans tracking-widest font-medium">
            &copy; 2026 常溫編集所 Ambient Edit Studio.
        </p>
    </footer>

    <!-- Logic Script -->
    <script>
        // Data Store & Migration
        let rawRecords = JSON.parse(localStorage.getItem('ambientTimeRecords')) || [];
        
        // Migration: ensure all records have recordTime
        let records = rawRecords.map(r => ({
            ...r,
            recordTime: r.recordTime || r.id // Default to ID if no recordTime exists
        }));
        
        // State
        let currentView = 'day'; 
        let editingRecordId = null; 
        
        // Confirm Modal State
        let pendingAction = null; // { type: 'delete' | 'export', id?: number }
        
        // Chart Instances
        let radarChartInstance = null;
        let barChartInstance = null;

        // Colors
        const colors = {
            sage: '#8da399',
            clay: '#d4a59a',
            ink: '#4a4a4a',
            sand: '#e6e2dd',
            paper: '#fdfbf7',
            sageTransparent: 'rgba(141, 163, 153, 0.5)'
        };

        function init() {
            switchView('day');
        }

        // --- Core Logic: View Switching ---
        function switchView(view) {
            currentView = view;
            
            ['day', 'week', 'month'].forEach(v => {
                const btn = document.getElementById(`btn-${v}`);
                if (v === view) {
                    btn.classList.remove('tab-inactive');
                    btn.classList.add('tab-active');
                } else {
                    btn.classList.remove('tab-active');
                    btn.classList.add('tab-inactive');
                }
            });

            const titleMap = {
                'day': { main: '今日足跡', sub: "Today's Footprint", sum: '今日專注總計' },
                'week': { main: '本週足跡', sub: "Weekly Footprint", sum: '本週專注總計' },
                'month': { main: '本月足跡', sub: "Monthly Footprint", sum: '本月專注總計' }
            };
            document.getElementById('listTitle').textContent = titleMap[view].main;
            document.getElementById('listSubtitle').textContent = titleMap[view].sub;
            document.getElementById('summaryTitle').textContent = titleMap[view].sum;

            refreshDisplay();
        }

        // --- Core Logic: Filtering & Grouping ---
        function getFilteredRecords() {
            const now = new Date();
            const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            return records.filter(record => {
                const recordDate = new Date(record.recordTime);
                
                if (currentView === 'day') {
                    return recordDate.toDateString() === now.toDateString();
                } 
                else if (currentView === 'week') {
                    const dayOfWeek = now.getDay();
                    const startOfWeek = new Date(startOfDay);
                    startOfWeek.setDate(now.getDate() - dayOfWeek);
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    endOfWeek.setHours(23, 59, 59, 999);
                    return recordDate >= startOfWeek && recordDate <= endOfWeek;
                } 
                else if (currentView === 'month') {
                    return recordDate.getMonth() === now.getMonth() && 
                           recordDate.getFullYear() === now.getFullYear();
                }
                return true;
            });
        }

        function groupRecordsByDate(filteredRecords) {
            filteredRecords.sort((a, b) => b.recordTime - a.recordTime);
            
            const groups = {};
            filteredRecords.forEach(record => {
                const dateKey = new Date(record.recordTime).toDateString();
                if (!groups[dateKey]) {
                    groups[dateKey] = [];
                }
                groups[dateKey].push(record);
            });
            return groups;
        }

        function refreshDisplay() {
            const displayRecords = getFilteredRecords();
            renderList(displayRecords);
            updateCharts(displayRecords);
            updateSummary(displayRecords);
        }

        // --- Core Logic: Confirmation Modal (Delete & Export) ---
        
        function askDelete(id) {
            pendingAction = { type: 'delete', id: id };
            
            // UI setup for Delete
            const iconContainer = document.getElementById('confirmIcon');
            iconContainer.className = 'w-12 h-12 mx-auto rounded-full flex items-center justify-center mb-4 transition-colors bg-brand-clay/10 text-brand-clay';
            iconContainer.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>';
            
            document.getElementById('confirmTitle').innerText = '刪除確認';
            document.getElementById('confirmMessage').innerText = '這段時光紀錄將被永久移除，確定要執行嗎？';
            
            // Show Cancel Button
            document.getElementById('confirmCancelBtn').classList.remove('hidden-visually');
            
            const confirmBtn = document.getElementById('confirmActionBtn');
            confirmBtn.innerText = '確認刪除';
            confirmBtn.className = 'flex-1 py-2.5 rounded-lg text-white font-bold text-sm transition-all shadow-md bg-brand-clay hover:bg-brand-clay/80 shadow-brand-clay/20';
            
            openConfirmModal();
        }

        function askExport() {
            if (records.length === 0) {
                // Case: No records, show info modal
                pendingAction = null; 

                const iconContainer = document.getElementById('confirmIcon');
                iconContainer.className = 'w-12 h-12 mx-auto rounded-full flex items-center justify-center mb-4 transition-colors bg-brand-ink/10 text-brand-ink/40';
                // Folder Open / Empty icon
                iconContainer.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>';

                document.getElementById('confirmTitle').innerText = '尚無資料';
                document.getElementById('confirmMessage').innerText = '目前沒有任何時光紀錄可供匯出喔，請先寫入一些回憶吧。';

                // Hide Cancel Button
                document.getElementById('confirmCancelBtn').classList.add('hidden-visually');

                const confirmBtn = document.getElementById('confirmActionBtn');
                confirmBtn.innerText = '好的';
                confirmBtn.className = 'flex-1 py-2.5 rounded-lg text-white font-bold text-sm transition-all shadow-md bg-brand-ink/40 hover:bg-brand-ink/60 shadow-brand-ink/10';

                openConfirmModal();
                return;
            }

            // Case: Normal Export
            pendingAction = { type: 'export' };

            const iconContainer = document.getElementById('confirmIcon');
            iconContainer.className = 'w-12 h-12 mx-auto rounded-full flex items-center justify-center mb-4 transition-colors bg-brand-sage/10 text-brand-sage';
            iconContainer.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>';

            document.getElementById('confirmTitle').innerText = '匯出確認';
            document.getElementById('confirmMessage').innerText = '即將匯出目前的時光紀錄為 CSV 檔案，方便您進行保存與分析。';

            // Show Cancel Button
            document.getElementById('confirmCancelBtn').classList.remove('hidden-visually');

            const confirmBtn = document.getElementById('confirmActionBtn');
            confirmBtn.innerText = '確認匯出';
            confirmBtn.className = 'flex-1 py-2.5 rounded-lg text-white font-bold text-sm transition-all shadow-md bg-brand-sage hover:bg-brand-sage/80 shadow-brand-sage/20';

            openConfirmModal();
        }

        function openConfirmModal() {
            const modal = document.getElementById('confirmModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeConfirmModal() {
            const modal = document.getElementById('confirmModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            pendingAction = null;
        }

        // Action Triggered
        document.getElementById('confirmActionBtn').addEventListener('click', () => {
            if (pendingAction) {
                if (pendingAction.type === 'delete') {
                    performDelete(pendingAction.id);
                } else if (pendingAction.type === 'export') {
                    performExport();
                }
            }
            
            closeConfirmModal();
        });

        // --- Core Logic: Actions ---

        function performDelete(id) {
            records = records.filter(r => r.id !== id);
            saveData();
            refreshDisplay();
        }

        function performExport() {
            if (records.length === 0) return; // Double check

            const headers = ['紀錄ID', '日期', '時間', '事項名稱', '分類', '持續時間(分鐘)'];
            const rows = records.map(r => {
                const dateObj = new Date(r.recordTime);
                const dateStr = dateObj.toLocaleDateString('zh-TW');
                const timeStr = dateObj.toLocaleTimeString('zh-TW', { hour12: false });
                const taskSafe = `"${r.task.replace(/"/g, '""')}"`; 
                return [r.id, dateStr, timeStr, taskSafe, r.category, r.duration].join(',');
            });

            const csvContent = '\uFEFF' + [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `ambient_time_records_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- Core Logic: Adding & Editing ---
        document.getElementById('timeForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const task = document.getElementById('taskName').value;
            const category = document.getElementById('category').value;
            const duration = parseInt(document.getElementById('duration').value);

            if (task && duration) {
                const overlay = document.getElementById('successOverlay');
                overlay.classList.remove('hidden');
                void overlay.offsetWidth; 
                overlay.classList.remove('opacity-0');
                
                setTimeout(() => {
                    const now = Date.now();
                    const record = {
                        id: now,
                        recordTime: now,
                        task,
                        category,
                        duration,
                        timestamp: new Date().toLocaleString('zh-TW', { hour12: false })
                    };

                    records.push(record);
                    saveData();
                    refreshDisplay();
                    
                    document.getElementById('timeForm').reset();
                    document.getElementById('taskName').focus();

                    overlay.classList.add('opacity-0');
                    setTimeout(() => {
                        overlay.classList.add('hidden');
                    }, 500);
                    
                }, 1000);
            }
        });

        // Edit Modal Logic
        window.openEditModal = function(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;

            editingRecordId = id;
            document.getElementById('editId').value = id;
            document.getElementById('editTaskName').value = record.task;
            document.getElementById('editCategory').value = record.category;
            document.getElementById('editDuration').value = record.duration;

            const dateObj = new Date(record.recordTime);
            const yyyy = dateObj.getFullYear();
            const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
            const dd = String(dateObj.getDate()).padStart(2, '0');
            document.getElementById('editDate').value = `${yyyy}-${mm}-${dd}`;

            const hh = String(dateObj.getHours()).padStart(2, '0');
            const min = String(dateObj.getMinutes()).padStart(2, '0');
            document.getElementById('editTime').value = `${hh}:${min}`;

            const modal = document.getElementById('editModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        window.closeEditModal = function() {
            const modal = document.getElementById('editModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            editingRecordId = null;
        };

        document.getElementById('editForm').addEventListener('submit', (e) => {
            e.preventDefault();
            if (!editingRecordId) return;

            const task = document.getElementById('editTaskName').value;
            const category = document.getElementById('editCategory').value;
            const duration = parseInt(document.getElementById('editDuration').value);
            
            const dateVal = document.getElementById('editDate').value;
            const timeVal = document.getElementById('editTime').value;
            const newDate = new Date(`${dateVal}T${timeVal}`);

            const index = records.findIndex(r => r.id === editingRecordId);
            if (index !== -1) {
                records[index].task = task;
                records[index].category = category;
                records[index].duration = duration;
                
                if (!isNaN(newDate.getTime())) {
                    records[index].recordTime = newDate.getTime();
                    records[index].timestamp = newDate.toLocaleString('zh-TW', { hour12: false });
                }
            }

            saveData();
            refreshDisplay();
            closeEditModal();
        });

        function saveData() {
            localStorage.setItem('ambientTimeRecords', JSON.stringify(records));
        }

        // --- Rendering ---
        function renderList(data) {
            const listContainer = document.getElementById('recordList');
            listContainer.innerHTML = '';
            
            if (data.length === 0) {
                listContainer.innerHTML = `
                    <div class="text-center py-12 border-2 border-dashed border-brand-sand/50 rounded-xl bg-white/20">
                        <p class="text-brand-ink/30 font-serif mb-2 text-lg">No Records Found</p>
                        <p class="text-xs text-brand-ink/20">在這個時間範圍內還沒有紀錄。</p>
                    </div>
                `;
                return;
            }

            const groups = groupRecordsByDate(data);
            
            Object.keys(groups).forEach(dateStr => {
                const groupRecords = groups[dateStr];
                const dateObj = new Date(groupRecords[0].recordTime);
                
                const dateHeader = new Intl.DateTimeFormat('zh-TW', { 
                    month: 'long', 
                    day: 'numeric', 
                    weekday: 'long' 
                }).format(dateObj);
                
                const groupDiv = document.createElement('div');
                groupDiv.className = 'animate-slide-up';
                
                groupDiv.innerHTML = `
                    <div class="flex items-center gap-4 mb-3 mt-2">
                        <h3 class="font-serif font-bold text-brand-ink/80 text-lg border-b-2 border-brand-sage/20 pb-1 px-1">
                            ${dateHeader}
                        </h3>
                        <span class="text-xs text-brand-ink/30 bg-white px-2 py-0.5 rounded-full border border-brand-sand/50">
                            ${groupRecords.length} 筆紀錄
                        </span>
                    </div>
                `;
                
                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'space-y-3 pl-2';

                groupRecords.forEach(record => {
                    const item = document.createElement('div');
                    item.className = 'bg-white p-4 rounded-xl shadow-card border border-transparent hover:border-brand-sand transition-all duration-300 flex justify-between items-center group relative';
                    
                    let badgeColor = 'bg-brand-sand/30 text-brand-ink/70';
                    if(record.category === '工作') badgeColor = 'bg-blue-50 text-blue-600';
                    if(record.category === '學習') badgeColor = 'bg-purple-50 text-purple-600';
                    if(record.category === '休息') badgeColor = 'bg-green-50 text-brand-sage';
                    if(record.category === '浪費') badgeColor = 'bg-gray-100 text-gray-400 decoration-line-through';

                    const timeDisplay = new Date(record.recordTime).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });

                    item.innerHTML = `
                        <div class="flex items-start gap-4 pointer-events-none">
                            <div class="flex flex-col items-center min-w-[3rem]">
                                <span class="text-[10px] text-brand-ink/30 font-mono tracking-tighter">${timeDisplay}</span>
                            </div>
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-[10px] px-2 py-0.5 rounded-full ${badgeColor} font-bold tracking-wider">${record.category}</span>
                                    <h3 class="font-medium text-brand-ink text-sm md:text-base">${record.task}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 pl-4 border-l border-brand-sand/20 z-10">
                            <span class="font-serif font-bold text-brand-ink text-lg pointer-events-none">${record.duration}<span class="text-xs font-sans font-normal ml-0.5 text-brand-ink/40">m</span></span>
                            
                            <!-- Actions -->
                            <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="openEditModal(${record.id})" class="p-1.5 text-brand-ink/40 hover:text-brand-sage hover:bg-brand-paper rounded-full transition-all cursor-pointer" title="編輯">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                </button>
                                <button onclick="askDelete(${record.id})" class="p-1.5 text-brand-ink/40 hover:text-brand-clay hover:bg-red-50 rounded-full transition-all cursor-pointer" title="刪除">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                                </button>
                            </div>
                        </div>
                    `;
                    itemsContainer.appendChild(item);
                });

                groupDiv.appendChild(itemsContainer);
                listContainer.appendChild(groupDiv);
            });
        }

        function updateSummary(data) {
            const totalMinutes = data.reduce((acc, curr) => acc + curr.duration, 0);
            document.getElementById('totalTimeDisplay').innerText = totalMinutes;
            document.getElementById('totalCountDisplay').innerText = data.length;
        }

        function updateCharts(data) {
            const categories = ['工作', '學習', '休息', '生活', '浪費'];
            
            const dataMap = categories.map(cat => {
                return data
                    .filter(r => r.category === cat)
                    .reduce((sum, r) => sum + r.duration, 0);
            });

            // Radar
            const radarCtx = document.getElementById('radarChart').getContext('2d');
            if (radarChartInstance) radarChartInstance.destroy();

            radarChartInstance = new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: categories,
                    datasets: [{
                        label: '時間分佈',
                        data: dataMap,
                        backgroundColor: colors.sageTransparent,
                        borderColor: colors.sage,
                        pointBackgroundColor: colors.ink,
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: colors.ink,
                        borderWidth: 2,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(230, 226, 221, 0.8)' },
                            grid: { color: 'rgba(230, 226, 221, 0.8)' },
                            pointLabels: {
                                font: { family: '"Noto Sans TC"', size: 12, weight: '500' },
                                color: colors.ink
                            },
                            ticks: { display: false, backdropColor: 'transparent' },
                            suggestedMin: 0
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            // Bar
            const barCtx = document.getElementById('barChart').getContext('2d');
            if (barChartInstance) barChartInstance.destroy();

            barChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [{
                        label: '分鐘',
                        data: dataMap,
                        backgroundColor: ['#8da399', '#a6b5ad', '#d4a59a', '#e6e2dd', '#4a4a4a'],
                        borderRadius: 6,
                        borderSkipped: false,
                        barThickness: 20
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { display: false },
                            ticks: { font: { family: '"Noto Serif TC"' }, color: colors.ink }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { family: '"Noto Sans TC"' }, color: colors.ink }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Start
        init();

    </script>
</body>
</html>
